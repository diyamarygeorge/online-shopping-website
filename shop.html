<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shop — Demo Shop</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f5f7fb; }
    .material-card { border-radius:12px; box-shadow: 0 10px 30px rgba(12,20,40,0.06); overflow:hidden; }
    .card-img-top { width:100%; height:180px; object-fit:cover; }
    .product-actions > * { margin-right:6px; }
    .form-input { border-radius:8px; box-shadow: inset 0 2px 6px rgba(0,0,0,0.03); }
    .snackbar { visibility:hidden; min-width:200px; background:#323232; color:#fff; text-align:center; border-radius:6px; padding:10px 14px; position:fixed; left:50%; transform:translateX(-50%); bottom:30px; z-index:9999; font-size:14px; }
    .snackbar.show { visibility:visible; animation: fadein .25s, fadeout .5s 2.4s; }
    @keyframes fadein{ from{opacity:0;bottom:10px} to{opacity:1;bottom:30px} }
    @keyframes fadeout{ from{opacity:1;bottom:30px} to{opacity:0;bottom:10px} }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">Shop</a>
      <div class="collapse navbar-collapse" id="navMain">
        <ul class="navbar-nav ms-auto align-items-center">
          <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
          <li class="nav-item" id="addProductNav" style="display:none"><a class="nav-link" href="add_product.html">Add Product</a></li>
          <li class="nav-item"><a class="nav-link" href="cart.html">Cart</a></li>
          <li class="nav-item"><a class="nav-link text-danger" href="#" id="logoutBtn">Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="m-0">Products</h4>
      <div><input id="searchInput" class="form-control form-input" placeholder="Search products..." style="width:240px; display:inline-block;"></div>
    </div>

    <div id="productsRow" class="row"></div>
    <div id="noProducts" class="text-center text-muted mt-4" style="display:none">No products found. Admins can <a href="add_product.html">add a product</a>.</div>
  </main>

  <div id="snackbar" class="snackbar"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const LS_PRODUCTS = 'products';
    const LS_USERS = 'users';
    const LS_LOGGEDIN = 'loggedInUser';
    const LS_CART = 'cart';

    function showSnackbar(msg){
      const s = document.getElementById('snackbar');
      s.textContent = msg; s.classList.add('show');
      setTimeout(()=> s.classList.remove('show'), 2600);
    }
    function getProducts(){ try { return JSON.parse(localStorage.getItem(LS_PRODUCTS) || '[]'); } catch { return []; } }
    function saveProducts(list){ localStorage.setItem(LS_PRODUCTS, JSON.stringify(list)); }
    function getUsers(){ try { return JSON.parse(localStorage.getItem(LS_USERS) || '[]'); } catch { return []; } }
    function getCart(){ try { return JSON.parse(localStorage.getItem(LS_CART) || '[]'); } catch { return []; } }
    function saveCart(c){ localStorage.setItem(LS_CART, JSON.stringify(c)); }

    function ensureDefaults(){
      const users = getUsers();
      if(!users.some(u => u.email === 'admin@gmail.com')){
        users.push({ id: users.length ? Math.max(...users.map(u=>u.id))+1 : 1, name:'Admin', email:'admin@gmail.com', password:'admin123', isAdmin:true });
        localStorage.setItem(LS_USERS, JSON.stringify(users));
      }
      const prods = getProducts();
      if(!prods || prods.length === 0){
        const sample = [
          { id:1, name:'Comfort Beanie', price:299, description:'Soft knit beanie', imagename:'https://picsum.photos/seed/beanie/600/400' },
          { id:2, name:'Everyday Backpack', price:1299, description:'Durable backpack', imagename:'https://picsum.photos/seed/backpack/600/400' },
          { id:3, name:'Classic Sneakers', price:1999, description:'Comfortable sneakers', imagename:'https://picsum.photos/seed/sneakers/600/400' }
        ];
        saveProducts(sample);
      }
      if(!localStorage.getItem(LS_CART)) localStorage.setItem(LS_CART, JSON.stringify([]));
    }

    // require login
    const loggedEmail = localStorage.getItem(LS_LOGGEDIN);
    if(!loggedEmail) window.location.href = 'login.html';

    document.addEventListener('DOMContentLoaded', function(){
      ensureDefaults();
      setupNav();
      renderProducts();
      document.getElementById('searchInput').addEventListener('input', ()=> renderProducts(document.getElementById('searchInput').value.trim().toLowerCase()));
    });

    function setupNav(){
      const logged = localStorage.getItem(LS_LOGGEDIN);
      const users = getUsers();
      const me = users.find(u => u.email === logged) || null;
      if(me && me.isAdmin) document.getElementById('addProductNav').style.display = '';
      document.getElementById('logoutBtn').addEventListener('click', (e)=>{ e.preventDefault(); localStorage.removeItem(LS_LOGGEDIN); window.location.href='login.html'; });
    }

    function escapeHtml(str){ if(!str && str !== 0) return ''; return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'", '&#039;'); }

    function renderProducts(filterText=''){
      const row = document.getElementById('productsRow'); row.innerHTML = '';
      const prods = getProducts();
      const me = getUsers().find(u => u.email === localStorage.getItem(LS_LOGGEDIN)) || null;
      const filtered = prods.filter(p => !filterText ? true : (p.name + ' ' + p.description).toLowerCase().includes(filterText));
      if(filtered.length === 0) document.getElementById('noProducts').style.display = ''; else document.getElementById('noProducts').style.display = 'none';

      filtered.forEach(p => {
        const col = document.createElement('div'); col.className = 'col-md-4 mb-4';
        col.innerHTML = `
          <div class="card material-card h-100">
            <img src="${escapeHtml(p.imagename||'https://picsum.photos/seed/default/600/400')}" class="card-img-top" alt="${escapeHtml(p.name)}">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">${escapeHtml(p.name)}</h5>
              <p class="card-text small mb-2">${escapeHtml(p.description)}</p>
              <div class="mt-auto d-flex justify-content-between align-items-center">
                <strong class="h6 mb-0">₹ ${Number(p.price)}</strong>
                <div class="product-actions">
                  <button class="btn btn-sm btn-primary material-btn add-to-cart" data-id="${p.id}">Add to Cart</button>
                  ${ (me && me.isAdmin) ? `<a class="btn btn-sm btn-outline-secondary" href="edit_product.html?id=${p.id}">Edit</a>
                  <button class="btn btn-sm btn-outline-danger delete-product" data-id="${p.id}">Delete</button>` : '' }
                </div>
              </div>
            </div>
          </div>`;
        row.appendChild(col);
      });

      document.querySelectorAll('.add-to-cart').forEach(btn=> btn.addEventListener('click', (e)=> addToCart(Number(e.currentTarget.dataset.id))));
      document.querySelectorAll('.delete-product').forEach(btn=> btn.addEventListener('click', (e)=> deleteProduct(Number(e.currentTarget.dataset.id))));
    }

    function addToCart(productId){
      const p = getProducts().find(x=>x.id===productId);
      if(!p) return showSnackbar('Product not found');
      let cart = getCart();
      const existing = cart.find(i=>i.id===productId);
      if(existing) existing.qty = Number(existing.qty) + 1; else cart.push({ id:p.id, name:p.name, price:p.price, qty:1, imagename:p.imagename });
      saveCart(cart); showSnackbar('Added to cart');
    }

    function deleteProduct(productId){
      if(!confirm('Delete this product?')) return;
      let prods = getProducts(); prods = prods.filter(p=>p.id!==productId); saveProducts(prods);
      showSnackbar('Product deleted');
      setTimeout(()=> renderProducts(document.getElementById('searchInput').value.trim().toLowerCase()), 300);
    }
  </script>
</body>
</html>
